# Kế Hoạch Kỹ Thuật #0013 - Data Persistence (Lưu Trữ Dữ Liệu)

## 1. Mô Tả Ngữ Cảnh

Xây dựng chức năng lưu trữ toàn bộ trạng thái dữ liệu của ứng dụng (tất cả các danh sách trong các Manager) vào các file JSON và tải lại khi ứng dụng khởi động. Điều này đảm bảo dữ liệu không bị mất giữa các phiên làm việc.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:
- `src/main/java/io/FileHandler.java` - Lớp xử lý việc đọc và ghi file.
- `src/main/java/io/JsonConverter.java` - Lớp tiện ích để chuyển đổi đối tượng Java sang chuỗi JSON và ngược lại.

### Tệp THAY ĐỔI:
- `pom.xml` - Thêm thư viện `Gson` để xử lý JSON.
- `src/main/java/Main.java` - Gọi `loadData` khi khởi động và `saveData` khi thoát.
- Tất cả các lớp Model (`Customer`, `Service`, v.v.) - Thêm constructor mặc định (không tham số) nếu cần cho việc deserialization.

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Thêm Thư Viện Gson

Thêm dependency sau vào `pom.xml` để xử lý JSON một cách hiệu quả:
```xml
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.10.1</version>
</dependency>
```

### 3.2 Cấu Trúc Lớp JsonConverter

Lớp này sẽ chứa các phương thức tĩnh để đơn giản hóa việc chuyển đổi.

```java
public class JsonConverter {
    private static final Gson gson = new GsonBuilder()
        .setPrettyPrinting() // Để file JSON dễ đọc
        .registerTypeAdapter(LocalDate.class, new LocalDateAdapter())
        .registerTypeAdapter(LocalDateTime.class, new LocalDateTimeAdapter())
        .create();

    /**
     * Chuyển một mảng đối tượng sang chuỗi JSON.
     * @param items Mảng đối tượng.
     * @return Chuỗi JSON.
     */
    public static <T> String toJson(T[] items) {
        return gson.toJson(items);
    }

    /**
     * Chuyển chuỗi JSON sang một mảng đối tượng.
     * @param json Chuỗi JSON.
     * @param arrayClass Class của mảng (ví dụ: Customer[].class).
     * @return Mảng đối tượng.
     */
    public static <T> T[] fromJson(String json, Class<T[]> arrayClass) {
        return gson.fromJson(json, arrayClass);
    }
}
```
*Lưu ý: Cần tạo các lớp `LocalDateAdapter` và `LocalDateTimeAdapter` để Gson biết cách xử lý `LocalDate` và `LocalDateTime`.*

### 3.3 Cấu Trúc Lớp FileHandler

```java
public class FileHandler {
    private final String dataDirectory; // Thư mục để lưu file (ví dụ: "data/")

    public FileHandler(String dataDirectory) {
        this.dataDirectory = dataDirectory;
        // Tạo thư mục nếu chưa tồn tại
    }

    /**
     * Ghi một mảng đối tượng vào file JSON.
     * @param filename Tên file (ví dụ: "customers.json").
     * @param items Mảng đối tượng cần ghi.
     */
    public <T> void writeToFile(String filename, T[] items) {
        String json = JsonConverter.toJson(items);
        // Logic ghi chuỗi json vào file tại đường dẫn dataDirectory + filename
    }

    /**
     * Đọc dữ liệu từ file JSON và chuyển thành mảng đối tượng.
     * @param filename Tên file.
     * @param arrayClass Class của mảng.
     * @return Mảng đối tượng đọc từ file.
     */
    public <T> T[] readFromFile(String filename, Class<T[]> arrayClass) {
        // Logic đọc nội dung file thành chuỗi
        String json = //...
        if (json == null || json.isEmpty()) {
            return (T[]) Array.newInstance(arrayClass.getComponentType(), 0);
        }
        return JsonConverter.fromJson(json, arrayClass);
    }
}
```

### 3.4 Tích Hợp Vào `Main.java`

```java
public class Main {
    public static void main(String[] args) {
        // Khởi tạo Managers, Services, ...
        FileHandler fileHandler = new FileHandler("data");

        // 1. Tải dữ liệu khi khởi động
        loadAllData(fileHandler, customerManager, serviceManager, ...);

        // 2. Chạy ứng dụng
        MainMenu mainMenu = new MainMenu(...);
        mainMenu.run();

        // 3. Lưu dữ liệu khi kết thúc
        saveAllData(fileHandler, customerManager, serviceManager, ...);
        System.out.println("Đã lưu dữ liệu. Hẹn gặp lại!");
    }

    public static void loadAllData(FileHandler handler, ...) {
        Customer[] customers = handler.readFromFile("customers.json", Customer[].class);
        for (Customer c : customers) customerManager.add(c);
        // Làm tương tự cho các manager khác...
    }

    public static void saveAllData(FileHandler handler, ...) {
        handler.writeToFile("customers.json", customerManager.getAll());
        // Làm tương tự cho các manager khác...
    }
}
```

---

## 4. Ghi Chú Kỹ Thuật

- **Thư mục dữ liệu:** Tạo một thư mục con (ví dụ: `data/`) trong thư mục gốc của dự án để chứa các file JSON. Thư mục này nên được thêm vào `.gitignore`.
- **Xử lý lỗi:** `FileHandler` cần có các khối `try-catch` để xử lý các `IOException` khi đọc/ghi file.
- **Dữ liệu rỗng:** Khi file không tồn tại hoặc rỗng, `readFromFile` nên trả về một mảng rỗng thay vì `null` để tránh `NullPointerException`.
- **Custom Type Adapters:** `LocalDate` và `LocalDateTime` không được Gson hỗ trợ mặc định, do đó cần phải tạo các `TypeAdapter` riêng để định dạng chúng thành chuỗi (ví dụ: ISO-8601) và ngược lại.
- **Kế thừa:** Gson có thể gặp khó khăn khi deserialize JSON thành các đối tượng có kế thừa (ví dụ: `Employee` là abstract, `Technician` và `Receptionist` là cụ thể). Cần sử dụng `RuntimeTypeAdapterFactory` nếu gặp vấn đề này, hoặc lưu từng loại nhân viên vào file riêng (`technicians.json`, `receptionists.json`).

---

## 5. Luồng Hoạt Động

1.  **Ứng dụng khởi động:** `Main.java` gọi `loadAllData()`.
2.  `loadAllData()` yêu cầu `FileHandler` đọc từng file `.json`.
3.  `FileHandler` đọc file, chuyển nội dung cho `JsonConverter`.
4.  `JsonConverter` deserialize chuỗi JSON thành các mảng (`Customer[]`, `Service[]`, ...).
5.  Dữ liệu từ các mảng này được nạp vào các `Manager` tương ứng.
6.  **Người dùng tương tác với ứng dụng:** Dữ liệu được thêm/sửa/xóa trong bộ nhớ (trong các `Manager`).
7.  **Ứng dụng kết thúc:** `Main.java` gọi `saveAllData()`.
8.  `saveAllData()` lấy toàn bộ dữ liệu từ các `Manager` (dưới dạng mảng).
9.  `FileHandler` và `JsonConverter` serialize các mảng này thành JSON và ghi đè lên các file `.json` tương ứng.
