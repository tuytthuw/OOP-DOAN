# Kế Hoạch Kỹ Thuật #0004 - Xây Dựng Model Chiết Khấu (Discount Model)

## 1. Mô Tả Ngữ Cảnh

Tạo lớp `Discount` để quản lý các chương trình khuyến mãi/chiết khấu cho spa. Lớp này hỗ trợ hai loại chiết khấu: theo phần trăm (%) và theo số tiền cố định.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/models/Discount.java` - Lớp chính đại diện cho chiết khấu

### Tệp THAY ĐỔI:

- `src/main/java/models/Init.java` - Thêm khởi tạo dữ liệu Sample
- `src/main/java/enums/DiscountType.java` - Enum đã tồn tại, sử dụng lại

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp Discount

```
Discount
├── Thuộc tính (Attributes):
│   ├── discountId: String (ID duy nhất, định dạng: DISC_XXXXX)
│   ├── discountCode: String (Mã khuyến mãi, vd: "SUMMER2024")
│   ├── description: String (Mô tả chiết khấu)
│   ├── type: DiscountType (Loại: PERCENTAGE hoặc FIXED_AMOUNT)
│   ├── value: BigDecimal (Giá trị: nếu % thì 0-100, nếu tiền thì số tiền)
│   ├── minAmount: BigDecimal (Tối thiểu hóa đơn để áp dụng chiết khấu, có thể null)
│   ├── maxDiscount: BigDecimal (Chiết khấu tối đa, có thể null)
│   ├── startDate: LocalDate (Ngày bắt đầu có hiệu lực)
│   ├── endDate: LocalDate (Ngày kết thúc có hiệu lực)
│   ├── usageLimit: int (Giới hạn số lần sử dụng, -1 = không giới hạn)
│   ├── usageCount: int (Số lần đã sử dụng)
│   └── isActive: boolean (Chiết khấu có hoạt động không)
│
├── Phương Thức (Methods):
│   ├── Constructor(discountId, discountCode, description, type, value, startDate, endDate)
│   ├── calculateDiscount(originalAmount): BigDecimal (Tính tiền chiết khấu)
│   ├── isValidForDate(date): boolean (Kiểm tra chiết khấu có hợp lệ cho ngày nào không)
│   ├── canUse(): boolean (Kiểm tra chiết khấu có thể sử dụng không)
│   ├── incrementUsage(): void (Tăng lượt sử dụng)
│   ├── getDiscountInfo(): String (Trả về thông tin chi tiết)
│   ├── Getter/Setter cho tất cả thuộc tính
│   └── equals() & hashCode() (So sánh dựa trên discountId)
```

### 3.2 Logic Tính Toán Chiết Khấu

**Bước thực hiện `calculateDiscount(originalAmount)`:**

1. Kiểm tra chiết khấu có hợp lệ không (gọi `canUse()`)
2. Nếu loại chiết khấu là PERCENTAGE:
   - Tính: `discountAmount = originalAmount * (value / 100)`
   - Nếu `maxDiscount` được đặt: `discountAmount = min(discountAmount, maxDiscount)`
3. Nếu loại chiết khấu là FIXED_AMOUNT:
   - `discountAmount = value`
   - Nếu `originalAmount` bé hơn `minAmount`: chiết khấu không áp dụng
4. Trả về `discountAmount` (hoặc 0 nếu không áp dụng)

**Ví dụ:**

- Chiết khấu 10% cho đơn hàng 1,000,000 VND → 100,000 VND
- Chiết khấu 100,000 VND cố định cho đơn tối thiểu 500,000 VND → áp dụng 100,000 VND
- Chiết khấu 100,000 VND cố định cho đơn 400,000 VND → không áp dụng (dưới minAmount)

### 3.3 Logic Kiểm Tra Hợp Lệ

**Bước thực hiện `canUse()`:**

1. Kiểm tra `isActive` có true không
2. Kiểm tra ngày hiện tại có nằm trong khoảng [startDate, endDate] không
3. Kiểm tra số lần sử dụng:
   - Nếu `usageLimit == -1`: không giới hạn → trả về true
   - Nếu `usageLimit > 0` và `usageCount < usageLimit`: trả về true
   - Ngược lại: trả về false
4. Trả về kết quả tổng hợp (tất cả điều kiện đều true)

### 3.4 Logic Kiểm Tra Hợp Lệ Ngày

**Bước thực hiện `isValidForDate(date)`:**

1. Kiểm tra `date >= startDate`
2. Kiểm tra `date <= endDate`
3. Trả về kết quả

---

## 4. Ghi Chú Kỹ Thuật

- Sử dụng `BigDecimal` để tính toán tiền tệ chính xác
- Sử dụng `LocalDate` để quản lý kỳ hạn chiết khấu
- Các trường `minAmount` và `maxDiscount` có thể null (tùy chọn)
- Phương thức `calculateDiscount()` không tự động tăng `usageCount`, phải gọi `incrementUsage()` riêng
- ID chiết khấu nên được sinh tự động hoặc được cung cấp khi tạo
- Sử dụng Enum `DiscountType` đã được định nghĩa
- Comment bằng tiếng Việt cho Javadoc và logic phức tạp
