# Kế Hoạch Kỹ Thuật #0012 - Exception Handling & Custom Exceptions

## 1. Mô Tả Ngữ Cảnh

Tạo các lớp ngoại lệ (Custom Exceptions) riêng cho ứng dụng spa để xử lý lỗi một cách có hệ thống và rõ ràng. Cung cấp một layer xử lý ngoại lệ toàn cục và cơ chế logging lỗi.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/exceptions/BaseException.java` - Exception cơ sở
- `src/main/java/exceptions/EntityNotFoundException.java` - Entity không tìm thấy
- `src/main/java/exceptions/InvalidEntityException.java` - Entity không hợp lệ
- `src/main/java/exceptions/BusinessLogicException.java` - Lỗi logic nghiệp vụ
- `src/main/java/exceptions/PaymentException.java` - Lỗi thanh toán
- `src/main/java/exceptions/AppointmentException.java` - Lỗi lịch hẹn
- `src/main/java/exceptions/ValidationException.java` - Lỗi validation input
- `src/main/java/exceptions/ExceptionHandler.java` - Bộ xử lý exception toàn cục (tùy chọn)

### Tệp THAY ĐỔI:

- Tất cả Manager classes (0007) - Thêm throws exception
- Tất cả Service classes (0008) - Thêm throws exception và try-catch
- `src/main/java/io/InputHandler.java` (0009) - Throw ValidationException
- `src/main/java/ui/MainMenu.java` (0010) - Try-catch exception toàn cục

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp BaseException

```
abstract BaseException (extends Exception)
├── Thuộc tính (Attributes):
│   ├── errorCode: String (Mã lỗi riêng, vd: "ERR_001")
│   ├── errorMessage: String (Thông báo lỗi chi tiết)
│   ├── timestamp: LocalDateTime (Thời gian xảy ra lỗi)
│   └── stackTrace: String (Stack trace cho debug)
│
├── Phương Thức (Methods):
│   ├── Constructor(errorCode, message)
│   ├── Constructor(errorCode, message, cause)
│   ├── getErrorCode(): String
│   ├── getErrorMessage(): String
│   ├── getTimestamp(): LocalDateTime
│   ├── getFormattedError(): String (Trả về thông báo định dạng)
│   └── logError(): void (Ghi log lỗi)
```

### 3.2 Danh Sách Custom Exceptions

#### **1. EntityNotFoundException**

```java
/**
 * Exception khi không tìm thấy entity trong database/manager
 * Sử dụng khi: getById() trả về null
 */
public class EntityNotFoundException extends BaseException {
    public EntityNotFoundException(String entityName, String id) {
        super("ERR_001",
              "Không tìm thấy " + entityName + " với ID: " + id);
    }
}

// Ví dụ sử dụng:
Customer customer = customerManager.getById("CUST_001");
if (customer == null) {
    throw new EntityNotFoundException("Customer", "CUST_001");
}
```

#### **2. InvalidEntityException**

```java
/**
 * Exception khi entity không hợp lệ (validation thất bại)
 * Sử dụng khi: validateItem() trả về false
 */
public class InvalidEntityException extends BaseException {
    public InvalidEntityException(String entityName, String reason) {
        super("ERR_002",
              "Entity " + entityName + " không hợp lệ: " + reason);
    }
}

// Ví dụ sử dụng:
if (customer.getFullName() == null || customer.getFullName().isEmpty()) {
    throw new InvalidEntityException("Customer", "Tên không được để trống");
}
```

#### **3. BusinessLogicException**

```java
/**
 * Exception khi logic nghiệp vụ không được phép
 * Sử dụng khi: điều kiện kinh doanh không thỏa mãn
 */
public class BusinessLogicException extends BaseException {
    public BusinessLogicException(String operation, String reason) {
        super("ERR_003",
              "Không thể " + operation + ": " + reason);
    }
}

// Ví dụ sử dụng:
if (appointment.getStatus() != AppointmentStatus.SCHEDULED) {
    throw new BusinessLogicException("hoàn thành lịch hẹn",
                                     "Chỉ lịch hẹn SCHEDULED mới được hoàn thành");
}
```

#### **4. PaymentException**

```java
/**
 * Exception khi xử lý thanh toán thất bại
 * Sử dụng khi: payment processing error
 */
public class PaymentException extends BaseException {
    public PaymentException(String reason) {
        super("ERR_004", "Lỗi thanh toán: " + reason);
    }
}

// Ví dụ sử dụng:
if (transaction.getAmount().compareTo(invoice.getTotalAmount()) < 0) {
    throw new PaymentException("Số tiền thanh toán không đủ");
}
```

#### **5. AppointmentException**

```java
/**
 * Exception khi có lỗi liên quan lịch hẹn
 * Sử dụng khi: appointment operation failed
 */
public class AppointmentException extends BaseException {
    public AppointmentException(String operation, String reason) {
        super("ERR_005",
              "Lỗi lịch hẹn (" + operation + "): " + reason);
    }
}

// Ví dụ sử dụng:
if (appointment.getAppointmentDateTime().isBefore(LocalDateTime.now())) {
    throw new AppointmentException("tạo lịch hẹn",
                                   "Thời gian hẹn không được trong quá khứ");
}
```

#### **6. ValidationException**

```java
/**
 * Exception khi validation input từ người dùng thất bại
 * Sử dụng khi: InputHandler validate thất bại
 */
public class ValidationException extends BaseException {
    public ValidationException(String fieldName, String requirement) {
        super("ERR_006",
              "Validation thất bại - " + fieldName + ": " + requirement);
    }
}

// Ví dụ sử dụng:
if (!email.matches("^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$")) {
    throw new ValidationException("Email", "Email không hợp lệ");
}
```

### 3.3 Phương Thức trong BaseException

#### **Logic `getFormattedError(): String`:**

```
Định dạng:
═══════════════════════════════════════
❌ LỖI CHƯƠNG TRÌNH
═══════════════════════════════════════
Mã Lỗi: ERR_001
Thời Gian: 2025-10-17 14:30:45
Thông Báo: Không tìm thấy Customer với ID: CUST_001
═══════════════════════════════════════
```

#### **Logic `logError(): void`:**

```java
// Pseudo-code
logger.error("[" + errorCode + "] " + errorMessage);
logger.debug("Stack trace: " + this.toString());
```

### 3.4 Cấu Trúc ExceptionHandler (Tùy Chọn)

```
ExceptionHandler (Singleton)
├── Phương Thức:
│   ├── handleException(exception): void (Xử lý exception toàn cục)
│   ├── logException(exception): void (Ghi log exception)
│   ├── displayErrorToUser(exception): void (Hiển thị lỗi cho người dùng)
│   └── getErrorMessage(errorCode): String (Lấy thông báo theo mã lỗi)
```

#### **Logic `handleException(exception): void`:**

```
1. Ghi log exception: logException(exception)
2. Phân loại exception:
   - Nếu BaseException: hiển thị getFormattedError()
   - Nếu NullPointerException: log "Lỗi Null Pointer"
   - Nếu exception khác: log generic error
3. Nếu is critical (payment, appointment): ghi vào error log file
4. Trả về error message cho UI
```

### 3.5 Cách Sử Dụng Exception

#### **Trong Manager Classes:**

```java
// CustomerManager
public boolean add(Customer customer) throws InvalidEntityException {
    if (!validateItem(customer)) {
        throw new InvalidEntityException("Customer",
                                        "ID hoặc Tên không hợp lệ");
    }

    if (exists(customer.getCustomerId())) {
        throw new InvalidEntityException("Customer",
                                        "ID đã tồn tại");
    }

    items.add(customer);
    return true;
}
```

#### **Trong Service Classes:**

```java
// CustomerService
public Customer registerNewCustomer(...)
    throws ValidationException, BusinessLogicException {

    try {
        // Validate input
        if (fullName == null || fullName.isEmpty()) {
            throw new ValidationException("Tên khách hàng",
                                         "Không được để trống");
        }

        // Check duplicate
        if (customerManager.findByPhone(phoneNumber) != null) {
            throw new BusinessLogicException("đăng ký khách hàng",
                                           "SĐT đã tồn tại");
        }

        // Create and add
        Customer customer = new Customer(...);
        customerManager.add(customer);
        return customer;

    } catch (InvalidEntityException e) {
        throw new BusinessLogicException("đăng ký khách hàng",
                                        e.getErrorMessage());
    }
}
```

#### **Trong Menu Classes:**

```java
// CustomerMenu
public void addNewCustomer() {
    try {
        String fullName = input.readString("Tên khách hàng: ");
        String phoneNumber = input.readString("SĐT: ");
        String email = input.readString("Email: ");
        String address = input.readString("Địa chỉ: ");

        Customer customer = customerService.registerNewCustomer(
            fullName, phoneNumber, email, address);

        output.printSuccess("Thêm khách hàng thành công! ID: "
                           + customer.getCustomerId());

    } catch (ValidationException e) {
        output.printError("Lỗi nhập liệu: " + e.getErrorMessage());
    } catch (BusinessLogicException e) {
        output.printError("Lỗi: " + e.getErrorMessage());
    } catch (Exception e) {
        output.printError("Lỗi không mong đợi: " + e.getMessage());
    }
}
```

### 3.6 Mã Lỗi Chuẩn

| Mã Lỗi    | Ý Nghĩa                  | Phục Hồi                                  |
| --------- | ------------------------ | ----------------------------------------- |
| `ERR_001` | Entity không tìm thấy    | Yêu cầu người dùng nhập lại ID            |
| `ERR_002` | Entity không hợp lệ      | Validation error, show validation message |
| `ERR_003` | Business logic error     | Giải thích tại sao không thể thực hiện    |
| `ERR_004` | Payment error            | Kiểm tra số tiền, phương thức thanh toán  |
| `ERR_005` | Appointment error        | Kiểm tra trạng thái, thời gian            |
| `ERR_006` | Validation error (input) | Yêu cầu nhập lại theo đúng format         |
| `ERR_999` | Unknown error            | Log full stack trace, contact admin       |

---

## 4. Ghi Chú Kỹ Thuật

- `BaseException` extends `Exception`, không phải `RuntimeException`
- Sử dụng checked exceptions để buộc xử lý (throws/try-catch)
- Luôn ghi log exception để debug
- Không bao giờ "swallow" exception (catch rồi không làm gì)
- Error message phải rõ ràng, giúp người dùng hiểu vấn đề
- Nếu sử dụng logging library: log4j, slf4j, hoặc tự viết Logger đơn giản

---

## 5. Integration Points

### 5.1 Manager Classes (0007)

Thêm `throws` clause:

```java
public boolean add(T item) throws InvalidEntityException { }
public boolean update(T item) throws InvalidEntityException { }
public T getById(String id) throws EntityNotFoundException { }
```

### 5.2 Service Classes (0008)

Bắt và re-throw với context:

```java
try {
    customerManager.add(customer);
} catch (InvalidEntityException e) {
    throw new BusinessLogicException("đăng ký khách hàng",
                                    e.getErrorMessage());
}
```

### 5.3 Menu Classes (0010)

Try-catch để hiển thị lỗi:

```java
try {
    // Xử lý logic
} catch (ValidationException e) {
    output.printError(e.getFormattedError());
} catch (BusinessLogicException e) {
    output.printError(e.getFormattedError());
}
```

---

## 6. Lợi Ích Của Exception Handling

| Lợi Ích         | Mô Tả                           |
| --------------- | ------------------------------- |
| **Rõ Ràng**     | Biết chính xác lỗi xảy ra ở đâu |
| **Dễ Debug**    | Stack trace giúp tìm lỗi nhanh  |
| **Có Hệ Thống** | Mỗi loại lỗi có exception riêng |
| **An Toàn**     | Không throw generic Exception   |
| **Dễ Bảo Trì**  | Thêm loại lỗi mới dễ dàng       |

---

## 7. Lưu Ý Quan Trọng

- ⚠️ **Ưu tiên:** Kế hoạch 0012 nên được thực hiện **TRƯỚC hoặc SONG SONG** với 0007-0010
- ⚠️ **Tương thích:** Tất cả Manager, Service, Menu cần cập nhật để sử dụng exceptions
- ✅ **Best Practice:** Sử dụng checked exceptions cho expected errors
