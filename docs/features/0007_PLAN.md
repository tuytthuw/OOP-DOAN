# Kế Hoạch Kỹ Thuật #0007 - Xây Dựng Collection Manager (Dùng Mảng T[])

## ⚠️ CẬP NHẬT: Tuân thủ Instructions - KHÔNG dùng java.util.List/ArrayList, phải dùng mảng T[]

## 1. Mô Tả Ngữ Cảnh

Tạo các lớp quản lý tập hợp dữ liệu (Collection Manager) để lưu trữ và quản lý các danh sách khách hàng, dịch vụ, lịch hẹn, giao dịch, chiết khấu và hóa đơn.

**Tuân thủ:** Không dùng java.util.List/ArrayList, dùng mảng T[] với dynamic resizing.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/collections/BaseManager.java` - Lớp generic cơ sở (sử dụng mảng T[])
- `src/main/java/collections/CustomerManager.java` - Quản lý danh sách khách hàng
- `src/main/java/collections/ServiceManager.java` - Quản lý danh sách dịch vụ
- `src/main/java/collections/AppointmentManager.java` - Quản lý danh sách lịch hẹn
- `src/main/java/collections/TransactionManager.java` - Quản lý danh sách giao dịch
- `src/main/java/collections/DiscountManager.java` - Quản lý danh sách chiết khấu
- `src/main/java/collections/InvoiceManager.java` - Quản lý danh sách hóa đơn

### Tệp THAY ĐỔI:

- `src/main/java/collections/Init.java` - Thêm khởi tạo tất cả managers

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 BaseManager<T> Generic - Cấu Trúc Cơ Sở (Dùng Mảng T[])

**Thuộc tính (Attributes):**

```
BaseManager<T>
├── items: T[] (Mảng lưu trữ các đối tượng)
├── size: int (Số lượng phần tử hiện tại)
├── capacity: int (Dung lượng hiện tại của mảng)
└── DEFAULT_CAPACITY: int (= 10 - dung lượng ban đầu)
```

**Phương Thức Chung (CRUD):**

```
[Entity]Manager extends BaseManager<[Entity]>
├── Phương Thức Chung (Common Methods):
│   ├── add([Entity]): boolean
│   │   Logic:
│   │   1. Kiểm tra item != null
│   │   2. Kiểm tra ID không trùng (gọi exists(id))
│   │   3. Nếu size >= capacity: gọi resize() để tăng dung lượng
│   │   4. Thêm item: items[size] = item; size++
│   │   5. Trả về true
│   │
│   ├── update([Entity]): boolean
│   │   Logic:
│   │   1. Kiểm tra item != null
│   │   2. Tìm vị trí của item trong mảng (dựa trên ID)
│   │   3. Nếu tìm thấy: thay thế items[index] = item; trả về true
│   │   4. Nếu không tìm: trả về false
│   │
│   ├── delete(id): boolean
│   │   Logic:
│   │   1. Tìm vị trí item có ID tương ứng
│   │   2. Nếu không tìm: trả về false
│   │   3. Xóa: dịch chuyển các phần tử sau lên một vị trí
│   │   4. size--
│   │   5. Trả về true
│   │
│   ├── getById(id): [Entity]
│   │   Logic:
│   │   1. Duyệt mảy từ 0 đến size-1
│   │   2. So sánh ID với getItemId(items[i])
│   │   3. Nếu tìm thấy: trả về items[i]
│   │   4. Nếu hết mảng: trả về null
│   │
│   ├── getAll(): [Entity][]
│   │   Logic:
│   │   1. Tạo mảng mới: copy[] = new [Entity][size]
│   │   2. Copy từng phần tử từ items vào copy
│   │   3. Trả về copy (tránh thay đổi từ bên ngoài)
│   │
│   ├── size(): int
│   │   Logic: Trả về biến size
│   │
│   ├── clear(): void
│   │   Logic: Đặt lại size = 0
│   │
│   ├── exists(id): boolean
│   │   Logic: return getById(id) != null
│   │
│   └── resize(): void (Phương thức riêng)
│       Logic (Tăng gấp đôi dung lượng):
│       1. newCapacity = capacity * 2
│       2. newItems = new [Entity][newCapacity]
│       3. Copy tất cả items cũ sang newItems
│       4. items = newItems
│       5. capacity = newCapacity
│
└── Phương Thức Tìm Kiếm Cụ Thể (Entity-specific Methods)
```

### 3.2 CustomerManager - Quản Lý Khách Hàng

**Extends**: BaseManager<Customer>

**Phương thức bổ sung:**

- `findByPhone(phoneNumber): Customer` - Tìm khách hàng theo số điện thoại
- `findByEmail(email): Customer` - Tìm khách hàng theo email
- `findByTier(tier): Customer[]` - Tìm tất cả khách hàng thuộc tier nào đó (trả về mảng)
- `findActiveCustomers(): Customer[]` - Lấy tất cả khách hàng hoạt động (trả về mảng)
- `getTopSpenders(limit): Customer[]` - Lấy top N khách hàng chi tiêu nhiều nhất (trả về mảng)

### 3.3 ServiceManager - Quản Lý Dịch Vụ

**Extends**: BaseManager<Service>

**Phương thức bổ sung:**

- `findByCategory(category): Service[]` - Tìm dịch vụ theo loại (trả về mảng)
- `findByName(name): Service[]` - Tìm dịch vụ theo tên (chứa chuỗi, trả về mảng)
- `findActiveServices(): Service[]` - Lấy tất cả dịch vụ hoạt động (trả về mảng)
- `findByPriceRange(minPrice, maxPrice): Service[]` - Tìm dịch vụ trong khoảng giá (trả về mảng)
- `getServicesByDuration(duration): Service[]` - Tìm dịch vụ theo khoảng thời gian (trả về mảng)

### 3.4 AppointmentManager - Quản Lý Lịch Hẹn

**Extends**: BaseManager<Appointment>

**Phương thức bổ sung:**

- `findByCustomerId(customerId): Appointment[]` - Tìm lịch hẹn của khách hàng (trả về mảng)
- `findByServiceId(serviceId): Appointment[]` - Tìm lịch hẹn dịch vụ nào (trả về mảng)
- `findByStatus(status): Appointment[]` - Tìm lịch hẹn theo trạng thái (trả về mảng)
- `findByDateRange(startDate, endDate): Appointment[]` - Tìm lịch hẹn trong khoảng ngày (trả về mảng)
- `findUpcomingAppointments(): Appointment[]` - Lấy lịch hẹn sắp tới (SCHEDULED, trả về mảng)
- `getExpiredAppointments(): Appointment[]` - Lấy lịch hẹn quá hạn (trả về mảng)

### 3.5 TransactionManager - Quản Lý Giao Dịch

**Extends**: BaseManager<Transaction>

**Phương thức bổ sung:**

- `findByCustomerId(customerId): Transaction[]` - Tìm giao dịch của khách hàng (trả về mảng)
- `findByStatus(status): Transaction[]` - Tìm giao dịch theo trạng thái (trả về mảng)
- `findByPaymentMethod(method): Transaction[]` - Tìm giao dịch theo phương thức thanh toán (trả về mảng)
- `findByDateRange(startDate, endDate): Transaction[]` - Tìm giao dịch trong khoảng ngày (trả về mảng)
- `getTotalRevenue(startDate, endDate): BigDecimal` - Tính tổng doanh thu (chỉ count SUCCESS)

### 3.6 DiscountManager - Quản Lý Chiết Khấu

**Extends**: BaseManager<Discount>

**Phương thức bổ sung:**

- `findByCode(discountCode): Discount` - Tìm chiết khấu theo mã
- `findActiveDiscounts(): Discount[]` - Lấy tất cả chiết khấu hoạt động (trả về mảng)
- `findByType(type): Discount[]` - Tìm chiết khấu theo loại (trả về mảng)
- `findValidDiscounts(date): Discount[]` - Lấy chiết khấu hợp lệ cho ngày nào đó (trả về mảy)
- `findDiscountsByCodePattern(pattern): Discount[]` - Tìm chiết khấu theo pattern mã (trả về mảng)

### 3.7 InvoiceManager - Quản Lý Hóa Đơn

**Extends**: BaseManager<Invoice>

**Phương thức bổ sung:**

- `findByCustomerId(customerId): Invoice[]` - Tìm hóa đơn của khách hàng (trả về mảng)
- `findByAppointmentId(appointmentId): Invoice` - Tìm hóa đơn của lịch hẹn
- `findByPaymentStatus(isPaid): Invoice[]` - Tìm hóa đơn theo trạng thái thanh toán (trả về mảng)
- `findByDateRange(startDate, endDate): Invoice[]` - Tìm hóa đơn trong khoảng ngày (trả về mảng)
- `getTotalRevenue(startDate, endDate): BigDecimal` - Tính tổng doanh thu từ hóa đơn (chỉ count isPaid)

---

## 4. Chi Tiết Logic Thêm Item & Resize

### 4.1 Logic Thêm Item - `add([Entity]): boolean`

**Bước thực hiện:**

1. Kiểm tra item không null
2. Kiểm tra ID không trùng lặp (gọi `exists(id)`)
3. Nếu trùng: trả về false
4. **Nếu size >= capacity**: gọi `resize()` để tăng dung lượng gấp đôi
5. Thêm item: `items[size] = item`
6. Tăng size: `size++`
7. Trả về true

### 4.2 Logic Cập Nhật Item - `update([Entity]): boolean`

**Bước thực hiện:**

1. Kiểm tra item không null
2. Tìm vị trí của item trong mảy (dựa trên ID)
3. Nếu không tìm thấy: trả về false
4. Thay thế item cũ bằng item mới: `items[index] = item`
5. Trả về true

### 4.3 Logic Xóa Item - `delete(id): boolean`

**Bước thực hiện (Hard Delete):**

1. Tìm vị trí item có ID tương ứng
2. Nếu không tìm thấy: trả về false
3. Xóa: dịch chuyển các phần tử sau lên một vị trí
   - `for i = index to size-2: items[i] = items[i+1]`
4. Tảng size: `size--`
5. Trả về true

### 4.4 Logic Resize - Tăng gấp đôi dung lượng

**Bước thực hiện:**

```
Trước resize:
  items[] = [C1, C2, C3, C4, C5]  (capacity = 10)
  size = 5

Khi size == capacity (giả sử sau thêm):
  size = 10, capacity = 10
  1. newCapacity = 10 * 2 = 20
  2. newItems[] = new [Entity][20]
  3. Copy: for i = 0 to 9: newItems[i] = items[i]
  4. items = newItems
  5. capacity = 20

Sau resize:
  items[] = [C1, C2, ..., C10, null, null, ..., null]  (capacity = 20)
  size = 10

Có thể tiếp tục thêm 10 phần tử nữa mà không cần resize
```

---

## 5. Ghi Chú Kỹ Thuật - Tuân thủ Instructions

⚠️ **BẮT BUỘC:**

- ❌ **KHÔNG** import `java.util.List`, `java.util.ArrayList`, `java.util.Set`, `java.util.HashMap`
- ✅ **PHẢI** dùng mảng `T[]` với logic quản lý thủ công
- ✅ **PHẢI** implement logic `resize()` để động mở rộng mảy
- ✅ **PHẢI** trả về mảng `T[]` từ các phương thức tìm kiếm (không null, mảng trống nếu không có kết quả)

**Chi tiết:**

- Sử dụng `T[]` để lưu trữ dữ liệu (dynamic array)
- Quản lý `size` (số phần tử hiện tại) và `capacity` (kích thước mảy)
- Khi `size >= capacity`, tự động gọi `resize()` để tăng gấp đôi
- Phương thức tìm kiếm trả về mảy con chứ không phải danh sách
- Nếu không có kết quả, trả về mảy trống (size = 0) chứ không phải null
- Comment bằng tiếng Việt cho Javadoc và logic phức tạp
- Không copy mảy nếu không cần thiết (để tiết kiệm bộ nhớ)
