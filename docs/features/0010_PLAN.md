# Kế Hoạch Kỹ Thuật #0010 - Xây Dựng Giao Diện Người Dùng (UI Menu System)

## ⚠️ TUÂN THỨ: Dùng Mảng T[], Không dùng List/ArrayList

## 1. Mô Tả Ngữ Cảnh

Tạo hệ thống menu console tương tác cho ứng dụng spa. Giao diện sẽ cho phép người dùng điều hướng qua các chức năng chính của ứng dụng (quản lý khách hàng, lịch hẹn, thanh toán, báo cáo).

**Nguyên tắc:**

- Menu nhận mảy từ Services/Managers
- Hiển thị mảy bằng OutputFormatter
- Throw exception nếu lỗi, UI layer catch & display

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/ui/MainMenu.java` - Menu chính
- `src/main/java/ui/CustomerMenu.java` - Menu quản lý khách hàng
- `src/main/java/ui/AppointmentMenu.java` - Menu quản lý lịch hẹn
- `src/main/java/ui/PaymentMenu.java` - Menu thanh toán
- `src/main/java/ui/ReportMenu.java` - Menu báo cáo
- `src/main/java/ui/MenuBase.java` - Lớp cơ sở cho tất cả menu (tùy chọn)

### Tệp THAY ĐỔI:

- `src/main/java/ui/Init.java` - Thêm khởi tạo tất cả menus
- `src/main/java/Main.java` - Gọi MainMenu để khởi chạy ứng dụng

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc MenuBase (Lớp Cơ Sở)

```java
abstract MenuBase {
    ├── Thuộc tính:
    │   └── managers: Các Manager được inject
    │
    ├── Phương Thức Chung:
    │   ├── displayMenu(): void (In menu chính)
    │   ├── handleChoice(choice): void (Xử lý lựa chọn)
    │   └── run(): void (Chạy menu loop)
    │
    └── Phương Thức Trừu Tượng:
        └── performAction(option): void
}
```

**Logic `run()`:**

1. Vòng lặp vô hạn:
   - Xóa màn hình (tùy chọn)
   - Gọi `displayMenu()` để hiển thị menu
   - Đọc lựa chọn từ người dùng: `choice = readOption()`
   - Gọi `handleChoice(choice)`
   - Nếu lựa chọn thoát: break vòng lặp
2. In thông báo tạm biệt và thoát

---

### 3.2 MainMenu - Menu Chính

**Cấu trúc:**

```
╔════════════════════════════════════╗
║   SPA MANAGEMENT SYSTEM v1.0       ║
║   Quản lý Spa Online              ║
╚════════════════════════════════════╝

1. Quản lý Khách hàng
2. Quản lý Lịch hẹn
3. Quản lý Thanh toán
4. Xem Báo cáo
5. Thoát

Vui lòng chọn (1-5): _
```

**Phương thức:**

- `displayMenu(): void` - In menu chính
- `handleChoice(choice): void` - Xử lý lựa chọn
- `run(): void` - Chạy vòng lặp chính

**Logic `handleChoice(choice)`:**

```
switch (choice) {
    case 1: mở CustomerMenu
    case 2: mở AppointmentMenu
    case 3: mở PaymentMenu
    case 4: mở ReportMenu
    case 5: thoát chương trình
    default: báo lỗi
}
```

---

### 3.3 CustomerMenu - Quản Lý Khách Hàng

**Cấu trúc:**

```
╔════════════════════════════════════╗
║   QUẢN LÝ KHÁCH HÀNG              ║
╚════════════════════════════════════╝

1. Thêm khách hàng mới
2. Xem danh sách khách hàng
3. Tìm kiếm khách hàng
4. Cập nhật thông tin khách hàng
5. Vô hiệu hóa khách hàng
6. Xem khách hàng theo Tier
7. Quay lại

Vui lòng chọn (1-7): _
```

**Phương thức:**

- `addNewCustomer(): void` - Thêm khách hàng
- `viewAllCustomers(): void` - Xem tất cả
- `searchCustomer(): void` - Tìm kiếm
- `updateCustomerInfo(): void` - Cập nhật
- `deactivateCustomer(): void` - Vô hiệu hóa
- `viewCustomerByTier(): void` - Xem theo Tier

**Logic `addNewCustomer()`:**

1. Yêu cầu nhập: Tên, SĐT, Email, Địa chỉ
2. Gọi `CustomerService.registerNewCustomer()`
3. Nếu thành công: hiển thị thông báo + ID khách hàng
4. Nếu lỗi: hiển thị thông báo lỗi

**Logic `viewAllCustomers()`:**

1. Lấy danh sách tất cả khách hàng từ CustomerManager dùng mảy
2. Nếu danh sách trống: in "Không có khách hàng"
3. In bảng với các cột: ID, Tên, SĐT, Email, Tier, Tổng Chi Tiêu
4. Gọi `OutputFormatter.displayCustomers(Customer[])`

```java
// ✅ ĐÚNG - Dùng mảy từ Manager
public void viewAllCustomers() {
    try {
        Customer[] customers = customerManager.getAll();
        if (customers.length == 0) {
            System.out.println("Không có khách hàng");
            return;
        }
        outputFormatter.displayCustomers(customers);
    } catch (Exception e) {
        System.out.println("Lỗi: " + e.getMessage());
    }
}
```

---

### 3.4 AppointmentMenu - Quản Lý Lịch Hẹn

**Cấu trúc:**

```
╔════════════════════════════════════╗
║   QUẢN LÝ LỊCH HẸN                ║
╚════════════════════════════════════╝

1. Đặt lịch hẹn mới
2. Xem lịch hẹn sắp tới
3. Xem lịch hẹn của khách hàng
4. Bắt đầu dịch vụ
5. Hoàn thành dịch vụ
6. Hủy lịch hẹn
7. Gán nhân viên
8. Quay lại

Vui lòng chọn (1-8): _
```

**Phương thức:**

- `bookNewAppointment(): void` - Đặt lịch hẹn
- `viewUpcomingAppointments(): void` - Xem sắp tới
- `viewCustomerAppointments(): void` - Xem của khách hàng
- `startAppointment(): void` - Bắt đầu
- `completeAppointment(): void` - Hoàn thành
- `cancelAppointment(): void` - Hủy bỏ
- `assignStaff(): void` - Gán nhân viên

**Logic `bookNewAppointment()`:**

1. Yêu cầu nhập: Customer ID, Service ID, Ngày giờ
2. Gọi `AppointmentService.bookAppointment()`
3. Nếu thành công: hiển thị ID lịch hẹn và thông tin
4. Nếu lỗi: hiển thị lý do

---

### 3.5 PaymentMenu - Quản Lý Thanh Toán

**Cấu trúc:**

```
╔════════════════════════════════════╗
║   QUẢN LÝ THANH TOÁN              ║
╚════════════════════════════════════╝

1. Tạo hóa đơn
2. Áp dụng chiết khấu
3. Xử lý thanh toán
4. Xem lịch sử giao dịch
5. Hoàn tiền
6. Quay lại

Vui lòng chọn (1-6): _
```

**Phương thức:**

- `createInvoice(): void` - Tạo hóa đơn
- `applyDiscount(): void` - Áp dụng chiết khấu
- `processPayment(): void` - Xử lý thanh toán
- `viewTransactionHistory(): void` - Xem lịch sử
- `refundTransaction(): void` - Hoàn tiền

**Logic `processPayment()`:**

1. Yêu cầu nhập Invoice ID
2. Yêu cầu chọn phương thức thanh toán
3. Gọi `PaymentService.processPaymentForInvoice()`
4. In thông tin giao dịch (ID, Số tiền, Trạng thái)
5. Hiển thị thông báo thành công

---

### 3.6 ReportMenu - Báo Cáo & Thống Kê

**Cấu trúc:**

```
╔════════════════════════════════════╗
║   BÁO CÁO & THỐNG KÊ              ║
╚════════════════════════════════════╝

1. Doanh thu theo kỳ
2. Thống kê khách hàng
3. Thống kê lịch hẹn
4. Dịch vụ phổ biến
5. Phương thức thanh toán
6. Quay lại

Vui lòng chọn (1-6): _
```

**Phương thức:**

- `getRevenueReport(): void` - Báo cáo doanh thu
- `getCustomerStatistics(): void` - Thống kê khách hàng
- `getAppointmentStatistics(): void` - Thống kê lịch hẹn
- `getMostPopularService(): void` - Dịch vụ phổ biến
- `getPaymentMethodStats(): void` - Phương thức thanh toán

**Logic `getRevenueReport()`:**

1. Yêu cầu chọn khoảng thời gian (từ ngày đến ngày)
2. Gọi `ReportService.getTotalRevenueByDateRange()`
3. In kết quả với định dạng rõ ràng

---

## 4. Compliance & Ghi Chú Kỹ Thuật

### ❌ KHÔNG DÙNG:

```java
import java.util.List;
import java.util.ArrayList;
List<Customer> customers = new ArrayList<>();
customers.stream().forEach(...);
```

### ✅ PHẢI DÙNG:

```java
// Menu nhận mảy từ Service
Customer[] customers = customerService.getActiveCustomers();

// Hiển thị mảy
outputFormatter.displayCustomers(customers);

// Lọc/tìm kiếm dùng for thường
for (Customer c : customers) {
    if (c.getId().equals(searchId)) {
        // xử lý
    }
}
```

### Quy tắc UI Layer:

1. **Exception Handling**: Catch tất cả exceptions từ Services, hiển thị user-friendly message
2. **Array Display**: Nhận T[] từ Services, pass cho OutputFormatter
3. **Input Validation**: Dùng InputHandler để validate input
4. **Navigation**: Mỗi menu phải có option "Quay lại"
5. **Error Recovery**: Cho phép retry khi lỗi

### Cấu Trúc Try-Catch Mẫu:

```java
public void addNewCustomer() {
    try {
        String name = inputHandler.getString("Nhập tên: ");
        String phone = inputHandler.getPhoneNumber("Nhập SĐT: ");
        String email = inputHandler.getEmail("Nhập email: ");
        String address = inputHandler.getString("Nhập địa chỉ: ");

        Customer newCustomer = customerService.registerNewCustomer(
            name, phone, email, address
        );
        System.out.println("✓ Đăng ký thành công! ID: " + newCustomer.getId());
    } catch (ValidationException e) {
        System.out.println("✗ Lỗi: " + e.getMessage());
    } catch (EntityNotFoundException e) {
        System.out.println("✗ Không tìm thấy: " + e.getMessage());
    } catch (Exception e) {
        System.out.println("✗ Lỗi: " + e.getMessage());
    }
}
```

---

## 5. Tệp Cần Tạo / Thay Đổi

### ✅ Tệp TẠO MỚI:

- `src/main/java/ui/MainMenu.java`
- `src/main/java/ui/CustomerMenu.java`
- `src/main/java/ui/AppointmentMenu.java`
- `src/main/java/ui/PaymentMenu.java`
- `src/main/java/ui/ReportMenu.java`
- `src/main/java/ui/MenuBase.java` (abstract base class)

### ✅ Tệp THAY ĐỔI:

- `src/main/java/ui/Init.java` - Thêm khởi tạo tất cả menus
- `src/main/java/Main.java` - Gọi MainMenu để khởi chạy ứng dụng
