# Kế Hoạch Kỹ Thuật #0016 - Quản lý Nhập kho (Goods Receipt)

## 1. Mô Tả Ngữ Cảnh

Xây dựng một hệ thống để quản lý việc nhập sản phẩm vào kho. Chức năng này bao gồm việc tạo "Phiếu Nhập Kho" (`GoodsReceipt`) để ghi lại thông tin về sản phẩm, số lượng, nhà cung cấp và chi phí. Khi một phiếu nhập kho được xử lý, số lượng tồn kho của các sản phẩm tương ứng sẽ được cập nhật.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/models/GoodsReceipt.java` - Lớp thực thể cho phiếu nhập kho.
- `src/main/java/models/GoodsReceiptItem.java` - Lớp đại diện cho một dòng hàng trong phiếu nhập.
- `src/main/java/collections/GoodsReceiptManager.java` - Lớp quản lý danh sách các phiếu nhập kho.
- `src/main/java/services/InventoryService.java` - Lớp dịch vụ chứa logic nghiệp vụ liên quan đến kho hàng.

### Tệp THAY ĐỔI:

- `src/main/java/models/Product.java` - Cần có phương thức `increaseStock()`.
- `src/main/java/collections/ProductManager.java` - Được sử dụng bởi `InventoryService` để cập nhật sản phẩm.
- `src/main/java/ui/InventoryMenu.java` - (Tùy chọn) Tạo một menu mới trong UI để xử lý các nghiệp vụ kho.

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp `GoodsReceiptItem`

Đây là một lớp con đơn giản để chứa chi tiết của từng sản phẩm trong một phiếu nhập.

```java
public class GoodsReceiptItem {
    private String productId;       // ID của sản phẩm được nhập
    private int quantity;           // Số lượng nhập
    private BigDecimal purchasePrice; // Giá nhập tại thời điểm nhập
}
```

### 3.2 Cấu Trúc Lớp `GoodsReceipt`

```java
public class GoodsReceipt implements IEntity {
    private String receiptId;           // ID duy nhất, định dạng: GRN_XXXXX
    private String supplierName;        // Tên nhà cung cấp
    private LocalDate receiptDate;      // Ngày nhập kho
    private GoodsReceiptItem[] items;   // Mảng các sản phẩm được nhập
    private BigDecimal totalCost;       // Tổng chi phí của phiếu nhập
    private String employeeId;          // ID nhân viên thực hiện
    private boolean isProcessed;        // Trạng thái: đã xử lý (cập nhật vào kho) hay chưa

    // Constructor, Getters, Setters

    /**
     * Tính tổng chi phí dựa trên các item trong phiếu.
     */
    public void calculateTotalCost();
}
```

### 3.3 Cấu Trúc Lớp `InventoryService`

Lớp này sẽ điều phối logic nghiệp vụ giữa `GoodsReceiptManager` và `ProductManager`.

```java
public class InventoryService {
    private final GoodsReceiptManager goodsReceiptManager;
    private final ProductManager productManager;

    // Constructor

    /**
     * Tạo một phiếu nhập kho mới.
     * @return Phiếu nhập kho vừa tạo.
     */
    public GoodsReceipt createGoodsReceipt(String supplierName, GoodsReceiptItem[] items, String employeeId);

    /**
     * Xử lý một phiếu nhập kho, cập nhật số lượng sản phẩm vào kho.
     * @param receiptId ID của phiếu nhập kho.
     * @throws BusinessLogicException nếu có lỗi (phiếu đã xử lý, sản phẩm không tồn tại, v.v.).
     */
    public void processGoodsReceipt(String receiptId) throws BusinessLogicException;
}
```

### 3.4 Logic Chi Tiết Của `InventoryService.processGoodsReceipt()`

Đây là phương thức cốt lõi của nghiệp vụ nhập kho.

1.  Sử dụng `goodsReceiptManager.getById(receiptId)` để lấy phiếu nhập kho.
2.  Nếu không tìm thấy phiếu, `throw new EntityNotFoundException("Không tìm thấy phiếu nhập kho.")`.
3.  Kiểm tra `goodsReceipt.isProcessed()`. Nếu là `true`, `throw new BusinessLogicException("Phiếu nhập kho này đã được xử lý.")`.
4.  Bắt đầu một vòng lặp qua mảng `goodsReceipt.getItems()`.
5.  **Trong vòng lặp, với mỗi `GoodsReceiptItem`:**
    a.  Lấy `productId` và `quantity` từ item.
    b.  Sử dụng `productManager.getById(productId)` để tìm sản phẩm tương ứng.
    c.  Nếu sản phẩm không tồn tại, `throw new EntityNotFoundException("Sản phẩm với ID " + productId + " không tồn tại.")`.
    d.  Gọi phương thức `product.increaseStock(quantity)` để tăng số lượng tồn kho của sản phẩm.
    e.  Gọi `productManager.update(product)` để lưu lại thay đổi.
6.  **Sau khi vòng lặp kết thúc:**
    a.  Đánh dấu phiếu nhập kho đã được xử lý: `goodsReceipt.setProcessed(true)`.
    b.  Cập nhật lại phiếu nhập kho trong `goodsReceiptManager.update(goodsReceipt)`.

---

## 4. Ghi Chú Kỹ Thuật

- **Tính toàn vẹn dữ liệu:** Quá trình xử lý phiếu nhập kho nên được coi là một "giao dịch". Nếu có bất kỳ lỗi nào xảy ra giữa chừng (ví dụ: một sản phẩm không tồn tại), lý tưởng nhất là toàn bộ quá trình nên được hủy bỏ (rollback). Tuy nhiên, trong khuôn khổ dự án này, việc dừng lại và báo lỗi là chấp nhận được.
- **Giao diện người dùng:** Cần tạo một menu mới (`InventoryMenu`) cho phép người dùng thực hiện các chức năng: tạo phiếu nhập kho, xem danh sách phiếu, và xử lý phiếu nhập kho.
- **Chi phí:** `totalCost` trong `GoodsReceipt` được tính bằng `SUM(item.quantity * item.purchasePrice)`. Giá nhập (`purchasePrice`) có thể khác với giá bán (`basePrice`) của sản phẩm.
- **ID:** `receiptId` nên được sinh tự động theo định dạng `GRN_XXXXX` (Goods Receipt Note).
