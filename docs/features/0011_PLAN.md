# Kế Hoạch Kỹ Thuật #0011 - Xây Dựng Employee/Staff Management

## ⚠️ TUÂN THỨ: Dùng Mảng T[], Không dùng List/ArrayList

## 1. Mô Tả Ngữ Cảnh

Tạo các lớp để quản lý nhân viên spa (Employee, Receptionist, Technician). Các lớp này kế thừa từ `Person` và chứa thông tin về lương, kỹ năng, chứng chỉ và các vai trò khác nhau.

**Nguyên tắc:**

- Employee extends Person
- EmployeeManager extends BaseManager<Employee>
- Tất cả trả về mảy Employee[], không dùng List

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/models/Employee.java` - Lớp cơ sở cho nhân viên
- `src/main/java/models/Receptionist.java` - Lớp lễ tân
- `src/main/java/models/Technician.java` - Lớp kỹ thuật viên
- `src/main/java/enums/EmployeeRole.java` - Enum vai trò nhân viên
- `src/main/java/enums/EmployeeStatus.java` - Enum trạng thái nhân viên
- `src/main/java/collections/EmployeeManager.java` - Quản lý danh sách nhân viên

### Tệp THAY ĐỔI:

- `src/main/java/models/Init.java` - Thêm khởi tạo dữ liệu mẫu

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Enum EmployeeRole

```java
EmployeeRole {
    RECEPTIONIST,    // Lễ tân
    TECHNICIAN,      // Kỹ thuật viên
    MANAGER,         // Quản lý
    ADMIN            // Quản trị viên
}
```

### 3.2 Cấu Trúc Enum EmployeeStatus

```java
EmployeeStatus {
    ACTIVE,          // Hoạt động
    ON_LEAVE,        // Đang nghỉ phép
    SUSPENDED,       // Tạm dừng
    RESIGNED         // Đã từ chức
}
```

### 3.3 Cấu Trúc Lớp Employee

```
Employee (Abstract, extends Person)
├── Thuộc tính (Attributes):
│   ├── employeeId: String (ID duy nhất, định dạng: EMP_XXXXX)
│   ├── role: EmployeeRole (Vai trò)
│   ├── salary: BigDecimal (Lương cơ bản/tháng)
│   ├── hireDate: LocalDate (Ngày tuyển dụng)
│   ├── status: EmployeeStatus (Trạng thái)
│   ├── passwordHash: String (Hash của mật khẩu)
│   ├── department: String (Phòng ban)
│   └── notes: String (Ghi chú bổ sung)
│
├── Phương Thức (Methods):
│   ├── Constructor(employeeId, fullName, role, salary, hireDate)
│   ├── calculatePay(): BigDecimal (Tính lương - được override bởi lớp con)
│   ├── checkPassword(password): boolean (Kiểm tra mật khẩu)
│   ├── updatePassword(oldPassword, newPassword): boolean (Đổi mật khẩu)
│   ├── getYearsOfService(): int (Tính năm công tác)
│   ├── getEmployeeInfo(): String (Thông tin chi tiết)
│   ├── changeStatus(newStatus): void (Thay đổi trạng thái)
│   ├── isActive(): boolean (Kiểm tra đang hoạt động)
│   ├── Getter/Setter cho tất cả thuộc tính
│   └── equals() & hashCode() (So sánh dựa trên employeeId)
```

### 3.4 Cấu Trúc Lớp Receptionist (extends Employee)

```
Receptionist (extends Employee)
├── Thuộc tính Riêng:
│   ├── bonusPerSale: BigDecimal (Thưởng cho mỗi giao dịch)
│   └── totalSales: BigDecimal (Tổng giá trị giao dịch)
│
└── Phương Thức Override:
    ├── calculatePay(): BigDecimal
    │   → Lương = salary + (totalSales * bonusPerSale)
    └── addSale(amount): void (Cộng giá trị giao dịch)
```

### 3.5 Cấu Trúc Lớp Technician (extends Employee)

```
Technician (extends Employee)
├── Thuộc tính Riêng:
│   ├── skillSet: List<String> (Kỹ năng: "Massage", "Facial", v.v.)
│   ├── certifications: List<String> (Chứng chỉ)
│   ├── commissionRate: double (Tỷ lệ hoa hồng, %)
│   ├── totalCommission: BigDecimal (Tổng hoa hồng tích lũy)
│   └── performanceRating: double (Đánh giá hiệu suất, 0-5)
│
└── Phương Thức Override:
    ├── calculatePay(): BigDecimal
    │   → Lương = salary + totalCommission
    ├── addCommission(amount): void (Cộng hoa hồng)
    ├── addSkill(skill): void (Thêm kỹ năng)
    ├── addCertification(cert): void (Thêm chứng chỉ)
    ├── hasSkill(skill): boolean (Kiểm tra có kỹ năng)
    ├── hasCertification(cert): boolean (Kiểm tra có chứng chỉ)
    └── updatePerformanceRating(rating): void (Cập nhật đánh giá)
```

### 3.6 Logic Tính Lương

#### **Logic `calculatePay()` cho Receptionist:**

```
Công thức:
    Lương tháng = Salary cơ bản + (Tổng giao dịch * Thưởng/giao dịch)

Ví dụ:
    Salary cơ bản = 5,000,000 VND
    Tổng giao dịch = 100,000,000 VND
    Thưởng/giao dịch = 50,000 VND
    → Lương tháng = 5,000,000 + (100,000,000 * 50,000) = ?

    ❌ Công thức trên sai! Nên là:
    → Lương tháng = 5,000,000 + (số giao dịch * 50,000)

    Hoặc:
    → Lương tháng = 5,000,000 + min(Tổng giao dịch * 1%, 2,000,000)
```

#### **Logic `calculatePay()` cho Technician:**

```
Công thức:
    Lương tháng = Salary cơ bản + Tổng hoa hồng

Ví dụ:
    Salary cơ bản = 4,000,000 VND
    Tổng hoa hồng = 1,500,000 VND (từ các dịch vụ hoàn thành)
    → Lương tháng = 4,000,000 + 1,500,000 = 5,500,000 VND
```

### 3.7 Logic Kiểm Tra Mật Khẩu (AN TOÀN)

**CẢNH BÁO:** Không sử dụng `hashCode()` để hash mật khẩu. Phải sử dụng thuật toán hashing an toàn như SHA-256.

**Bước thực hiện `hashPassword(password)` (MỚI):**

```java
private String hashPassword(String password) {
    try {
        MessageDigest md = MessageDigest.getInstance("SHA-256");
        byte[] hashedBytes = md.digest(password.getBytes("UTF-8"));
        return Base64.getEncoder().encodeToString(hashedBytes);
    } catch (NoSuchAlgorithmException | UnsupportedEncodingException e) {
        // Trong một ứng dụng thực tế, cần xử lý lỗi này một cách cẩn thận
        throw new RuntimeException("Lỗi khi hashing mật khẩu", e);
    }
}
```

**Bước thực hiện `checkPassword(password)`:**

1. Hash password đầu vào: `inputHash = hashPassword(password)`
2. So sánh `inputHash` với `passwordHash` đã lưu
3. Trả về `true` nếu khớp, `false` nếu không

**Bước thực hiện `updatePassword(oldPassword, newPassword)`:**

1. Kiểm tra `oldPassword` đúng: gọi `checkPassword(oldPassword)`
   - Nếu sai: trả về `false`
2. Kiểm tra `newPassword` không trống và >= 6 ký tự
   - Nếu không hợp lệ: trả về `false`
3. Hash password mới: `newHash = hashPassword(newPassword)`
4. Cập nhật `passwordHash = newHash`
5. Trả về `true`

### 3.8 Logic Tính Năm Công Tác

**Bước thực hiện `getYearsOfService()`:**

1. Lấy ngày hiện tại: `LocalDate.now()`
2. Tính hiệu năm: `currentYear - hireDate.getYear()`
3. Nếu chưa tới ngày tuyển dụng năm nay: trừ 1 năm
4. Trả về số năm

### 3.9 Cấu Trúc EmployeeManager

```
EmployeeManager (extends BaseManager<Employee>)
├── Phương Thức Chung (từ BaseManager):
│   ├── add(employee): boolean
│   ├── update(employee): boolean
│   ├── delete(id): boolean
│   ├── getById(id): Employee
│   └── getAll(): List<Employee>
│
└── Phương Thức Tìm Kiếm Riêng:
    ├── findByRole(role): List<Employee>
    ├── findByStatus(status): List<Employee>
    ├── findActiveEmployees(): List<Employee>
    ├── findByDepartment(department): List<Employee>
    ├── findTechnicianWithSkill(skill): List<Technician>
    ├── findTechnicianWithCertification(cert): List<Technician>
    ├── getTopPerformers(limit): List<Technician>
    └── getTotalPayroll(): BigDecimal (Tính tổng lương phải trả)
```

---

## 4. Ghi Chú Kỹ Thuật

- `Employee` là **abstract class**, không thể instantiate trực tiếp
- `Receptionist` và `Technician` là **concrete classes**, có thể tạo instance
- Sử dụng `BigDecimal` để tính toán lương chính xác
- `passwordHash` nên sử dụng hashing algorithm an toàn (bcrypt, argon2, v.v.)
  - Trong ứng dụng console đơn giản này, có thể dùng MD5 hoặc SHA-256
- `skillSet`, `certifications` của Technician có thể là `List<String>` hoặc tạo enum riêng
- Comment bằng tiếng Việt cho Javadoc và logic phức tạp
- Không lưu password plaintext, chỉ lưu hash

---

## 5. Mối Quan Hệ Với Các Lớp Khác

```
Person (Abstract)
└── Employee (Abstract)
    ├── Receptionist (Concrete)
    └── Technician (Concrete)
```

**Liên kết với Appointment:**

- `Appointment.staffId` → có thể tìm Employee/Technician từ EmployeeManager
- Khi hoàn thành Appointment, cộng hoa hồng cho Technician

**Liên kết với Service:**

- Technician có `skillSet` → có thể check nếu có kỹ năng phục vụ cho dịch vụ nào

---

## 6. Integration Points

### 6.1 Cập Nhật AppointmentService (0008)

Khi hoàn thành Appointment, cần:

```java
// Trong AppointmentService.completeAppointment(appointmentId)
// Thêm logic:
Appointment apt = appointmentManager.getById(appointmentId);
Employee staff = employeeManager.getById(apt.getStaffId());

if (staff instanceof Technician) {
    Technician tech = (Technician) staff;
    // Cộng hoa hồng
    Service service = serviceManager.getById(apt.getServiceId());
    BigDecimal commission = service.getBasePrice()
        .multiply(BigDecimal.valueOf(tech.getCommissionRate() / 100));
    tech.addCommission(commission);
}
```

### 6.2 Cập Nhật InvoiceService (0008)

Khi tạo hóa đơn, nên ghi nhận Receptionist:

```java
// Thêm tham số cho Invoice
Invoice invoice = new Invoice(...);
invoice.setReceptionist(currentReceptionist);
```

---

## 7. Compliance & Ghi Chú Kỹ Thuật

### ❌ KHÔNG DÙNG:

```java
import java.util.List;
import java.util.ArrayList;
List<Employee> employees = new ArrayList<>();
employees.stream().filter(...).toList();
```

### ✅ PHẢI DÙNG:

```java
// EmployeeManager trả về mảy
Employee[] allEmployees = employeeManager.getAll();

// Tìm kiếm/lọc dùng for thường
Employee[] technicians = new Employee[allEmployees.length];
int count = 0;
for (Employee e : allEmployees) {
    if (e instanceof Technician) {
        technicians[count++] = e;
    }
}
Employee[] result = new Employee[count];
for (int i = 0; i < count; i++) {
    result[i] = technicians[i];
}
```

### EmployeeManager - Phương thức cần triển khai:

```java
public class EmployeeManager extends BaseManager<Employee> {

    // Từ BaseManager
    @Override
    protected String getItemId(Employee item) {
        return item.getEmployeeId();
    }

    // Phương thức tìm kiếm
    public Employee[] findByRole(EmployeeRole role) { }
    public Employee[] findByStatus(EmployeeStatus status) { }
    public Employee[] findActiveEmployees() { }
    public Technician[] getAllTechnicians() { }
    public Receptionist[] getAllReceptionists() { }

    // Phương thức thống kê
    public BigDecimal getTotalSalaryByMonth() { }
    public Employee[] getTopCommissionEarners(int limit) { }
}
```

### Quy tắc OOP:

1. **Inheritance**: Employee → (Receptionist, Technician)
2. **Polymorphism**: Override getEmployeeType(), getResponsibilities()
3. **Encapsulation**: Private fields, public getters/setters
4. **Abstract Methods**: Employee là abstract nếu cần

---

## 8. Tệp Cần Tạo / Thay Đổi

### ✅ Tệp TẠO MỚI:

- `src/main/java/models/Employee.java` (abstract hoặc concrete)
- `src/main/java/models/Receptionist.java`
- `src/main/java/models/Technician.java`
- `src/main/java/enums/EmployeeRole.java`
- `src/main/java/enums/EmployeeStatus.java`
- `src/main/java/collections/EmployeeManager.java`

### ✅ Tệp THAY ĐỔI:

- `src/main/java/models/Init.java` - Thêm khởi tạo dữ liệu mẫu nhân viên

---

## 9. Lưu Ý Quan Trọng

- ⚠️ **Ưu tiên:** Kế hoạch 0011 có thể được thực hiện **song song** với 0008-0010
- ⚠️ **Tương thích:** Kế hoạch 0008 (AppointmentService) sẽ cần cập nhật để tương tác với EmployeeManager
- ✅ **Thiết kế:** Sử dụng Inheritance, Polymorphism, Abstract classes

---

## 10. Ví Dụ Thực Thi

````java
// Tạo Technician mới - dùng mảy từ EmployeeManager
Technician tech = new Technician(
    "EMP_001",
    "Nguyễn Thị B",
    "0912345678",
    "b@spa.com",
    "123 Đường ABC",
    false,
    LocalDate.of(1995, 5, 15),
    BigDecimal.valueOf(4000000),
    LocalDate.of(2020, 1, 15),
    2.5  // commissionRate
);

// Thêm vào manager
employeeManager.add(tech);

// Lấy tất cả technician
Technician[] technicians = employeeManager.getAllTechnicians();

// Hiển thị
for (Technician t : technicians) {
    System.out.println(t.getId() + ": " + t.getFullName());
}
```// Tính lương
tech.addCommission(BigDecimal.valueOf(500000));
BigDecimal monthlyPay = tech.calculatePay();
// → 4,000,000 + 500,000 = 4,500,000 VND
````
