# Kế Hoạch Kỹ Thuật #0014 - Authentication Service (Dịch Vụ Xác Thực)

## 1. Mô Tả Ngữ Cảnh

Xây dựng một dịch vụ xác thực tập trung (`AuthService`) để quản lý trạng thái đăng nhập của người dùng (nhân viên), xử lý việc đăng nhập, đăng xuất và kiểm tra quyền truy cập. Dịch vụ này sẽ hoạt động như một Singleton để đảm bảo chỉ có một trạng thái đăng nhập duy nhất trong toàn bộ ứng dụng.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:
- `src/main/java/services/AuthService.java` - Lớp dịch vụ xác thực.
- `src/main/java/exceptions/AuthException.java` - Exception tùy chỉnh cho các lỗi xác thực.

### Tệp THAY ĐỔI:
- `src/main/java/ui/MainMenu.java` - Sử dụng `AuthService` để hiển thị menu phù hợp (trước và sau khi đăng nhập).
- Các menu con (ví dụ: `EmployeeMenu`, `ReportMenu`) - Kiểm tra quyền truy cập trước khi thực hiện các hành động nhạy cảm.
- `src/main/java/Main.java` - Khởi tạo `AuthService` với `EmployeeManager`.

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp `AuthException`

```java
public class AuthException extends Exception {
    public AuthException(String message) {
        super(message);
    }
}
```

### 3.2 Cấu Trúc Lớp `AuthService` (Singleton)

```java
public class AuthService {
    private static AuthService instance;
    private final EmployeeManager employeeManager;
    private Employee currentUser; // Nhân viên đang đăng nhập

    // Private constructor để ngăn tạo instance từ bên ngoài
    private AuthService(EmployeeManager employeeManager) {
        this.employeeManager = employeeManager;
        this.currentUser = null;
    }

    /**
     * Khởi tạo và lấy instance duy nhất của AuthService.
     * @param employeeManager Trình quản lý nhân viên.
     * @return Instance của AuthService.
     */
    public static synchronized AuthService getInstance(EmployeeManager employeeManager) {
        if (instance == null) {
            instance = new AuthService(employeeManager);
        }
        return instance;
    }

    /**
     * Xử lý đăng nhập cho nhân viên.
     * @param employeeId ID nhân viên.
     * @param password Mật khẩu.
     * @throws AuthException nếu đăng nhập thất bại.
     */
    public void login(String employeeId, String password) throws AuthException;

    /**
     * Đăng xuất người dùng hiện tại.
     */
    public void logout();

    /**
     * Lấy thông tin người dùng đang đăng nhập.
     * @return Employee đang đăng nhập, hoặc null.
     */
    public Employee getCurrentUser();

    /**
     * Kiểm tra xem đã có người dùng đăng nhập hay chưa.
     * @return true nếu đã đăng nhập, false nếu chưa.
     */
    public boolean isLoggedIn();

    /**
     * Kiểm tra xem người dùng hiện tại có một trong các vai trò được chỉ định không.
     * @param roles Danh sách các vai trò cần kiểm tra.
     * @return true nếu người dùng có ít nhất một trong các vai trò đó.
     */
    public boolean hasRole(EmployeeRole... roles);
}
```

### 3.3 Logic Chi Tiết Các Phương Thức

#### `login(employeeId, password)`
1.  Tìm kiếm nhân viên bằng `employeeId` thông qua `employeeManager.getById(employeeId)`.
2.  Nếu không tìm thấy nhân viên, `throw new AuthException("Tài khoản hoặc mật khẩu không chính xác.")`.
3.  Nếu tìm thấy, gọi phương thức `employee.checkPassword(password)` (đã được định nghĩa trong Kế hoạch #0011 với hashing an toàn).
4.  Nếu `checkPassword` trả về `true`:
    a.  Gán `this.currentUser = employee`.
    b.  In thông báo chào mừng.
5.  Nếu `checkPassword` trả về `false`, `throw new AuthException("Tài khoản hoặc mật khẩu không chính xác.")`.

#### `logout()`
1.  Gán `this.currentUser = null`.
2.  In thông báo đăng xuất thành công.

#### `getCurrentUser()`
1.  Trả về `this.currentUser`.

#### `isLoggedIn()`
1.  Trả về `this.currentUser != null`.

#### `hasRole(EmployeeRole... roles)`
1.  Kiểm tra nếu `isLoggedIn()` là `false`, trả về `false`.
2.  Lấy vai trò của `currentUser`: `currentUser.getRole()`.
3.  Duyệt qua mảng `roles` được truyền vào.
4.  Nếu vai trò của `currentUser` khớp với bất kỳ vai trò nào trong mảng, trả về `true`.
5.  Nếu không có vai trò nào khớp, trả về `false`.

---

## 4. Tích Hợp Vào Giao Diện Người Dùng (UI)

### `MainMenu.java`
- Trước vòng lặp `run()`, thêm chức năng yêu cầu người dùng đăng nhập.
- Trong `displayMenu()`, kiểm tra `authService.isLoggedIn()`:
    - Nếu `true`, hiển thị các menu chức năng (Quản lý khách hàng, Lịch hẹn, v.v.) và tùy chọn "Đăng xuất".
    - Nếu `false`, chỉ hiển thị tùy chọn "Đăng nhập" và "Thoát".
- `handleChoice()` sẽ gọi `authService.login()` hoặc `authService.logout()` tương ứng.

### Các Menu Yêu Cầu Quyền
Ví dụ trong `EmployeeMenu.java` hoặc `ReportMenu.java`:

```java
// Trước khi thực hiện một hành động nhạy cảm như thêm nhân viên mới
public void showAddEmployeeForm() {
    if (!authService.hasRole(EmployeeRole.ADMIN, EmployeeRole.MANAGER)) {
        outputFormatter.printError("Bạn không có quyền thực hiện chức năng này.");
        return;
    }
    // ... logic thêm nhân viên
}
```

---

## 5. Ghi Chú Kỹ Thuật

- **Singleton Pattern:** Sử dụng `synchronized` trong `getInstance` để đảm bảo an toàn trong môi trường đa luồng (mặc dù ứng dụng hiện tại là đơn luồng).
- **Bảo mật:** Tuyệt đối không lưu mật khẩu ở dạng văn bản thô. `AuthService` phải dựa vào phương thức `checkPassword` của `Employee`, nơi logic so sánh hash được thực hiện.
- **Phân Quyền:** Logic `hasRole` là một cơ chế phân quyền đơn giản (Role-Based Access Control - RBAC). Có thể mở rộng để kiểm tra các quyền chi tiết hơn trong tương lai.
- **Khởi tạo:** `AuthService` cần được khởi tạo một lần duy nhất trong `Main.java` và truyền vào các menu cần sử dụng nó.
