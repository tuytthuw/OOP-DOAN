# Kế Hoạch Kỹ Thuật #0006 - Xây Dựng Model Hóa Đơn (Invoice Model)

## 1. Mô Tả Ngữ Cảnh

Tạo lớp `Invoice` để quản lý hóa đơn chi tiết cho các lịch hẹn. Lớp này tổng hợp thông tin dịch vụ, chiết khấu, thuế và tính toán tổng tiền cuối cùng.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/models/Invoice.java` - Lớp chính đại diện cho hóa đơn

### Tệp THAY ĐỔI:

- `src/main/java/models/Init.java` - Thêm khởi tạo dữ liệu Sample

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp Invoice

```
Invoice
├── Thuộc tính (Attributes):
│   ├── invoiceId: String (ID duy nhất, định dạng: INV_XXXXX)
│   ├── appointmentId: String (ID lịch hẹn liên quan)
│   ├── customerId: String (ID khách hàng)
│   ├── issueDate: LocalDate (Ngày phát hành hóa đơn)
│   ├── subtotal: BigDecimal (Tổng tiền trước chiết khấu và thuế)
│   ├── discountAmount: BigDecimal (Số tiền chiết khấu áp dụng)
│   ├── taxAmount: BigDecimal (Số tiền thuế)
│   ├── totalAmount: BigDecimal (Tổng tiền cuối cùng)
│   ├── isPaid: boolean (Đã thanh toán hay chưa)
│   ├── paidDate: LocalDate (Ngày thanh toán, có thể null)
│   ├── paymentMethod: PaymentMethod (Phương thức thanh toán)
│   ├── discountCode: String (Mã chiết khấu áp dụng, có thể null)
│   └── notes: String (Ghi chú bổ sung)
│
├── Phương Thức (Methods):
│   ├── Constructor(invoiceId, appointmentId, customerId, subtotal, paymentMethod)
│   ├── applyDiscount(discountAmount, discountCode): void (Áp dụng chiết khấu)
│   ├── calculateTax(taxRate): void (Tính thuế)
│   ├── calculateTotal(): void (Tính tổng tiền)
│   ├── markAsPaid(paidDate): void (Đánh dấu đã thanh toán)
│   ├── getInvoiceInfo(): String (Trả về thông tin chi tiết)
│   ├── getFormattedInvoice(): String (Trả về hóa đơn định dạng)
│   ├── Getter/Setter cho tất cả thuộc tính
│   └── equals() & hashCode() (So sánh dựa trên invoiceId)
```

### 3.2 Logic Áp Dụng Chiết Khấu

**Bước thực hiện `applyDiscount(discountAmount, discountCode)`:**

1. Kiểm tra `discountAmount` không vượt quá `subtotal`
2. Cập nhật `discountAmount`
3. Ghi nhận mã chiết khấu
4. Gọi `calculateTotal()` để cập nhật tổng tiền

**Ví dụ:**

```
Subtotal: 1,000,000 VND
Discount: 100,000 VND (10%)
Tax Rate: 10%
  ↓
Subtotal - Discount = 900,000 VND
Tax = 900,000 * 10% = 90,000 VND
Total = 900,000 + 90,000 = 990,000 VND
```

### 3.3 Logic Tính Thuế

**Bước thực hiện `calculateTax(taxRate)`:**

1. Tính cơ sở tính thuế: `taxBase = subtotal - discountAmount`
2. Tính thuế: `taxAmount = taxBase * (taxRate / 100)`
3. Ghi nhận `taxAmount`
4. Gọi `calculateTotal()` để cập nhật tổng tiền

### 3.4 Logic Tính Tổng Tiền

**Bước thực hiện `calculateTotal()`:**

1. `totalAmount = subtotal - discountAmount + taxAmount`
2. Kiểm tra `totalAmount` không âm
3. Cập nhật trường `totalAmount`

**Quy tắc:**

- Nếu `totalAmount < 0` → đặt thành 0 hoặc báo lỗi

### 3.5 Logic Đánh Dấu Đã Thanh Toán

**Bước thực hiện `markAsPaid(paidDate)`:**

1. Kiểm tra `paidDate` không sau ngày hôm nay
2. Cập nhật `isPaid = true`
3. Ghi nhận ngày thanh toán: `paidDate`
4. Trả về thông báo thành công

### 3.6 Logic Định Dạng Hóa Đơn

**Bước thực hiện `getFormattedInvoice()`:**

1. Trả về chuỗi có format:

```
========== HÓA ĐƠN ==========
Mã HĐ: INV_XXXXX
Ngày phát hành: DD/MM/YYYY
Khách hàng: ID_XXXXX
---
Subtotal: 1,000,000 VND
Chiết khấu: -100,000 VND (Code)
Thuế (10%): 90,000 VND
---
TỔNG CỘNG: 990,000 VND
Trạng thái: Đã thanh toán / Chưa thanh toán
=============================
```

---

## 4. Ghi Chú Kỹ Thuật

- Sử dụng `BigDecimal` để tính toán tiền tệ chính xác
- Sử dụng `LocalDate` để quản lý ngày tháng
- Các trường `paidDate` và `discountCode` có thể null ban đầu
- Phương thức `getFormattedInvoice()` dùng để in hóa đơn ra console
- Phương thức `calculateTotal()` nên được gọi lại sau khi thay đổi bất kỳ giá trị nào
- ID hóa đơn nên được sinh tự động hoặc được cung cấp khi tạo
- Comment bằng tiếng Việt cho Javadoc và logic phức tạp
