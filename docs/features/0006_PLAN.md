# Kế Hoạch Kỹ Thuật #0006 - Xây Dựng Model Hóa Đơn (Invoice Model) - CẬP NHẬT

## 1. Mô Tả Ngữ Cảnh

Cập nhật lớp `Invoice` để quản lý hóa đơn chi tiết, cho phép chứa cả **dịch vụ (Service)** và **sản phẩm (Product)**. Hóa đơn không còn bị ràng buộc cứng với một `Appointment` duy nhất, thay vào đó nó sẽ quản lý một danh sách các mục hàng (`InvoiceItem`) có thể bán được.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:
- `src/main/java/models/InvoiceItem.java` - Lớp đại diện cho một dòng hàng trên hóa đơn.

### Tệp THAY ĐỔI:
- `src/main/java/models/Invoice.java` - Cập nhật cấu trúc để chứa danh sách các `InvoiceItem`.
- `src/main/java/services/InvoiceService.java` - Cập nhật logic tạo hóa đơn và thêm sản phẩm/dịch vụ.

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp `InvoiceItem` (Mới)

```java
public class InvoiceItem {
    private String sellableId;      // ID của Service hoặc Product
    private String itemName;        // Tên của item (để hiển thị)
    private int quantity;           // Số lượng
    private BigDecimal unitPrice;     // Đơn giá tại thời điểm bán
    private BigDecimal totalPrice;    // Thành tiền (quantity * unitPrice)

    // Constructor, Getters
}
```

### 3.2 Cấu Trúc Lớp `Invoice` (Cập nhật)

```java
public class Invoice implements IEntity {
    // Thuộc tính
    private String invoiceId;           // ID duy nhất, định dạng: INV_XXXXX
    private String customerId;          // ID khách hàng
    private String employeeId;          // ID nhân viên tạo hóa đơn
    private LocalDate issueDate;        // Ngày phát hành hóa đơn
    private InvoiceItem[] items;        // Mảng các dòng hàng (dịch vụ và sản phẩm)
    private BigDecimal subtotal;        // Tổng tiền trước chiết khấu và thuế
    private BigDecimal discountAmount;    // Số tiền chiết khấu
    private String discountCode;        // Mã chiết khấu đã áp dụng
    private BigDecimal taxAmount;         // Số tiền thuế
    private BigDecimal totalAmount;       // Tổng tiền cuối cùng
    private boolean isPaid;             // Đã thanh toán hay chưa
    // ... các thuộc tính khác nếu cần

    // Phương thức
    public void calculateSubtotal();    // Tính lại subtotal từ mảng items
    public void calculateTotal();       // Tính lại totalAmount
    // ... các phương thức khác
}
```
**Thay đổi chính:**
- Loại bỏ `appointmentId`.
- Thêm `customerId` và `employeeId`.
- Thay thế các liên kết đơn lẻ bằng mảng `InvoiceItem[]`.

### 3.3 Logic Cập Nhật trong `InvoiceService`

#### `createInvoice(customerId, employeeId)`
1.  Tạo một đối tượng `Invoice` mới với `customerId`, `employeeId`, `issueDate` là ngày hiện tại.
2.  Khởi tạo mảng `items` rỗng.
3.  Gán các giá trị tiền (`subtotal`, `totalAmount`, v.v.) là `BigDecimal.ZERO`.
4.  Lưu hóa đơn mới vào `InvoiceManager` và trả về.

#### `addItemToInvoice(invoiceId, sellableId, quantity)`
1.  Tìm `Invoice` bằng `invoiceId`.
2.  Tìm `Sellable` item (có thể là `Service` hoặc `Product`) bằng `sellableId` trong các Manager tương ứng.
3.  Nếu không tìm thấy item, `throw new EntityNotFoundException`.
4.  Kiểm tra `item.isAvailable()`. Nếu là `Product`, kiểm tra `stockQuantity >= quantity`. Nếu không đủ, `throw new BusinessLogicException`.
5.  Tạo một `InvoiceItem` mới với thông tin từ `Sellable` item (ID, tên, giá, số lượng).
6.  Thêm `InvoiceItem` mới vào mảng `items` của hóa đơn (cần logic để mở rộng mảng).
7.  Gọi `invoice.calculateSubtotal()` và `invoice.calculateTotal()` để cập nhật lại số tiền.
8.  Nếu item là `Product`, gọi `product.decreaseStock(quantity)` để giảm tồn kho.
9.  Cập nhật `Invoice` và `Product` trong các Manager tương ứng.

#### `calculateTotal()` (trong lớp `Invoice`)
1.  `subtotal = SUM(item.totalPrice)` cho tất cả `item` trong mảng `items`.
2.  `taxBase = subtotal - discountAmount`.
3.  `taxAmount = taxBase * taxRate` (giả sử `taxRate` được cấu hình ở đâu đó).
4.  `totalAmount = subtotal - discountAmount + taxAmount`.
5.  Đảm bảo `totalAmount` không âm.

---

## 4. Ghi Chú Kỹ Thuật

- **Linh hoạt:** Cấu trúc mới cho phép một hóa đơn chứa nhiều dịch vụ và sản phẩm, phù hợp hơn với thực tế kinh doanh.
- **Quản lý kho:** Việc giảm tồn kho (`decreaseStock`) nên được thực hiện khi thêm sản phẩm vào hóa đơn hoặc khi hóa đơn được xác nhận/thanh toán để đảm bảo tính chính xác. Gắn nó với sự kiện thanh toán sẽ an toàn hơn.
- **Giá cả:** `unitPrice` trong `InvoiceItem` nên được sao chép từ giá của sản phẩm/dịch vụ tại thời điểm bán, để nếu giá gốc thay đổi trong tương lai, hóa đơn cũ không bị ảnh hưởng.
- **Giao diện người dùng:** UI cần được cập nhật để cho phép người dùng tìm kiếm và thêm cả dịch vụ và sản phẩm vào một hóa đơn đang mở.

