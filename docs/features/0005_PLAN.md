# Kế Hoạch Kỹ Thuật #0005 - Xây Dựng Model Giao Dịch (Transaction Model)

## 1. Mô Tả Ngữ Cảnh

Tạo lớp `Transaction` để ghi nhận các giao dịch thanh toán từ khách hàng. Lớp này lưu trữ thông tin thanh toán, phương thức thanh toán, trạng thái và liên kết với lịch hẹn.

---

## 2. Các Tệp và Hàm Liên Quan

### Tệp TẠO MỚI:

- `src/main/java/models/Transaction.java` - Lớp chính đại diện cho giao dịch

### Tệp THAY ĐỔI:

- `src/main/java/models/Init.java` - Thêm khởi tạo dữ liệu Sample
- `src/main/java/enums/PaymentMethod.java` - Enum đã tồn tại, sử dụng lại

---

## 3. Thuật Toán / Logic (Từng Bước)

### 3.1 Cấu Trúc Lớp Transaction

```
Transaction
├── Thuộc tính (Attributes):
│   ├── transactionId: String (ID duy nhất, định dạng: TXN_XXXXX)
│   ├── appointmentId: String (ID lịch hẹn được thanh toán)
│   ├── customerId: String (ID khách hàng)
│   ├── amount: BigDecimal (Số tiền thanh toán)
│   ├── paymentMethod: PaymentMethod (Phương thức: CASH, CARD, TRANSFER, E_WALLET)
│   ├── transactionDate: LocalDateTime (Ngày giờ giao dịch)
│   ├── status: TransactionStatus (Trạng thái: PENDING, SUCCESS, FAILED, REFUNDED)
│   ├── referenceCode: String (Mã tham chiếu từ ngân hàng/cổng thanh toán)
│   ├── notes: String (Ghi chú bổ sung)
│   └── refundedAmount: BigDecimal (Số tiền hoàn lại, nếu có)
│
├── Phương Thức (Methods):
│   ├── Constructor(transactionId, appointmentId, customerId, amount, paymentMethod)
│   ├── processPayment(): void (Xử lý thanh toán - cập nhật status thành SUCCESS)
│   ├── failPayment(reason): void (Đánh dấu thanh toán thất bại)
│   ├── refundPayment(amount): void (Hoàn lại tiền)
│   ├── getTransactionInfo(): String (Trả về thông tin chi tiết)
│   ├── getAmountFormatted(): String (Trả về số tiền định dạng)
│   ├── isSuccessful(): boolean (Kiểm tra giao dịch thành công)
│   ├── Getter/Setter cho tất cả thuộc tính
│   └── equals() & hashCode() (So sánh dựa trên transactionId)
```

### 3.2 Cấu Trúc Enum TransactionStatus

```java
TransactionStatus {
    PENDING,      // Đang chờ xử lý
    SUCCESS,      // Thanh toán thành công
    FAILED,       // Thanh toán thất bại
    REFUNDED      // Đã hoàn tiền
}
```

### 3.3 Logic Xử Lý Thanh Toán

**Bước thực hiện `processPayment()`:**

1. Kiểm tra trạng thái hiện tại có phải PENDING không
2. Cập nhật status thành SUCCESS
3. Ghi nhận thời gian xử lý: `transactionDate = LocalDateTime.now()`
4. Trả về thông báo thành công

### 3.4 Logic Thanh Toán Thất Bại

**Bước thực hiện `failPayment(reason)`:**

1. Kiểm tra trạng thái hiện tại có phải PENDING không
2. Cập nhật status thành FAILED
3. Ghi nhận lý do vào `notes`
4. Trả về thông báo thất bại

### 3.5 Logic Hoàn Tiền

**Bước thực hiện `refundPayment(amount)`:**

1. Kiểm tra trạng thái có phải SUCCESS không
2. Kiểm tra số tiền hoàn lại không vượt quá số tiền gốc
3. Cập nhật status thành REFUNDED
4. Ghi nhận số tiền hoàn lại: `refundedAmount = amount`
5. Tính toán số tiền còn lại: `actualAmount = amount - refundedAmount`
6. Trả về thông báo thành công

### 3.6 Logic Kiểm Tra Thành Công

**Bước thực hiện `isSuccessful()`:**

1. Trả về `status == TransactionStatus.SUCCESS`

---

## 4. Ghi Chú Kỹ Thuật

- Sử dụng `BigDecimal` để quản lý số tiền chính xác
- Sử dụng `LocalDateTime` để ghi nhận thời gian giao dịch
- Trường `referenceCode` và `refundedAmount` có thể null/0 ban đầu
- Phương thức `getAmountFormatted()` định dạng số tiền với dấu phân cách hàng nghìn
- ID giao dịch nên được sinh tự động hoặc được cung cấp khi tạo
- Sử dụng Enum `PaymentMethod` đã được định nghĩa
- Cần tạo Enum `TransactionStatus` mới (chưa tồn tại)
- Comment bằng tiếng Việt cho Javadoc và logic phức tạp
